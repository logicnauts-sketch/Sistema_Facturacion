{% extends "home.html" %}

{% block title %}Cuadre de Caja{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/caja.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
{% endblock %}

{% block content %}
  <div class="container">
    <header>
      <div class="header-left">
        <div class="chip">
          <i class="fas fa-cash-register"></i>
          <strong>Cuadre de Caja</strong>
        </div>
        <div class="chip" id="statusChip">
          <span class="status-indicator status-closed"></span>
          Estado: Cargando...
        </div>
      </div>
      <div class="header-right">
        <button class="btn" id="btnCerrarTurno" disabled>
          <i class="fas fa-lock"></i> Cerrar Turno
        </button>
      </div>
    </header>

    <div class="grid grid-3">
      <!-- Panel de estado -->
      <div class="card col-4" id="panelEstado">
        <div class="card-header">
          <h2><i class="fas fa-chart-line"></i> Estado del Turno</h2>
        </div>
        
        <div class="stat-container">
          <div class="stat">
            <div class="label">Inicio</div>
            <div class="value" id="inicioVal">—</div>
          </div>
          <div class="stat">
            <div class="label">Fin</div>
            <div class="value" id="finVal">—</div>
          </div>
          <div class="stat">
            <div class="label">Cajero</div>
            <div class="value" id="cajeroVal">admin@tienda</div>
          </div>
          <div class="stat">
            <div class="label">Estado</div>
            <div class="value" id="estadoVal">Cargando...</div>
          </div>
        </div>
        
        <div class="divider"></div>
        
        <div class="input-group">
          <label for="inputInicial">Monto inicial</label>
          <input class="input" id="inputInicial" type="number" min="0" step="0.01" placeholder="Efectivo inicial" />
        </div>
        
        <div class="flex-row">
          <button class="btn btn-primary grow" id="btnAbrir">
            <i class="fas fa-lock-open"></i> Abrir Turno
          </button>
        </div>
      </div>

      <!-- Registro de ventas y gastos -->
      <div class="card col-8">
        <div class="card-header">
          <h2><i class="fas fa-receipt"></i> Actividad del Turno</h2>
        </div>
        
        <div class="facturacion-integration">
          
          <div class="facturacion-stats">
            <div class="facturacion-stat">
              <div class="label">Facturas Registradas</div>
              <div class="value" id="facturasRegistradas">0</div>
            </div>
            <div class="facturacion-stat">
              <div class="label">Última Factura</div>
              <div class="value" id="ultimaFactura">—</div>
            </div>
            <div class="facturacion-stat">
              <div class="label">Total Facturado</div>
              <div class="value" id="totalFacturado">RD$ 0.00</div>
            </div>
          </div>
        </div>
        
        <div class="divider"></div>
        
        <h3>Movimientos registrados</h3>
        <div class="table-container">
          <table class="table" id="tablaMovs">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Método</th>
                <th>Monto</th>
                <th>Hora</th>
                <th>Factura</th>
              </tr>
            </thead>
            <tbody id="tbodyMovs">
              <tr>
                <td colspan="6" class="empty-state">
                  <div class="spinner"></div>
                  <p>Cargando movimientos...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Modal para el cierre de caja -->
    <div class="modal" id="closeModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title"><i class="fas fa-calculator"></i> Cierre de Caja</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <h3>Total esperado</h3>
          <div class="summary">
            <div class="stat">
              <div class="label">Efectivo</div>
              <div class="value" id="modalExpCash">RD$ 0.00</div>
            </div>
            <div class="stat">
              <div class="label">Tarjeta</div>
              <div class="value" id="modalExpCard">RD$ 0.00</div>
            </div>
            <div class="stat">
              <div class="label">Total</div>
              <div class="value" id="modalExpTotal">RD$ 0.00</div>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <h3>Conteo físico</h3>
          <div class="flex-row">
            <div>
              <label>Efectivo contado</label>
              <input class="input" id="modalCntCash" type="number" min="0" step="0.01" placeholder="RD$" />
            </div>
            <div>
              <label>Tarjeta contada</label>
              <input class="input" id="modalCntCard" type="number" min="0" step="0.01" placeholder="RD$" />
            </div>
          </div>
          
          <div class="divider"></div>
          
          <h3>Diferencia</h3>
          <div class="summary">
            <div class="stat">
              <div class="label">Efectivo</div>
              <div class="value" id="modalDifCash">—</div>
            </div>
            <div class="stat">
              <div class="label">Tarjeta</div>
              <div class="value" id="modalDifCard">—</div>
            </div>
            <div class="stat">
              <div class="label">Total</div>
              <div class="value" id="modalDifTotal">—</div>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <div class="input-group">
            <label>Observaciones</label>
            <textarea class="input" id="modalObservaciones" rows="2" placeholder="Notas del cierre (opcional)"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="btnPrefill">
            <i class="fas fa-magic"></i> Autocompletar
          </button>
          <button class="btn btn-primary" id="btnCerrarModal">
            <i class="fas fa-lock"></i> Confirmar Cierre
          </button>
        </div>
      </div>
    </div>
    
    <!-- Modal para el reporte de cierre -->
    <div class="modal" id="reportModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title"><i class="fas fa-file-alt"></i> Reporte de Cierre</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="reporteContenido">
          <div class="spinner"></div>
          <p>Generando reporte...</p>
        </div>
        <div class="modal-footer">
            <button class="btn" id="btnImprimir">
                <i class="fas fa-print"></i> Imprimir Reporte
            </button>
            <button class="btn btn-primary" id="btnAceptarReporte">
                <i class="fas fa-check"></i> Aceptar
            </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
<script src="/static/js/caja.js"></script>
{% endblock %}